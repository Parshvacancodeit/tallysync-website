{% extends "base.html" %}

{% block title %}Generate XML - TallySync{% endblock %}

{% block content %}
<h1>ğŸ“„ Generated XML</h1>
<p style="color: #666; margin-bottom: 2rem;">Review and send XML to your connector</p>

<div style="padding: 1.5rem; background: #d4edda; border-radius: 1rem; margin-bottom: 2rem;">
    <h3>âœ… XML Generated Successfully</h3>
    <p style="margin-top: 0.5rem; color: #155724;">
        Your transactions have been converted to Tally XML format. Review below and send to connector.
    </p>
</div>

<div style="margin-bottom: 2rem;">
    <h3>XML Preview:</h3>
    <div style="background: #2d3748; color: #e2e8f0; padding: 1.5rem; border-radius: 0.5rem; overflow-x: auto; max-height: 500px; overflow-y: auto;">
        <pre style="margin: 0; font-family: 'Courier New', monospace; font-size: 0.875rem; line-height: 1.6;">{{ xml_data }}</pre>
    </div>
</div>

<div style="display: flex; gap: 1rem; justify-content: space-between; align-items: center;">
    <div>
        <a href="{{ url_for('transactions', statement_id=statement_id) }}" class="btn btn-secondary">â† Back to Transactions</a>
    </div>
    <div style="display: flex; gap: 1rem;">
        <button onclick="copyXML()" class="btn btn-secondary">ğŸ“‹ Copy XML</button>
        {% if connector_configured %}
        <button onclick="sendToConnector()" class="btn btn-primary" id="sendBtn">ğŸ“¤ Send to Connector</button>
        {% else %}
        <a href="{{ url_for('settings') }}" class="btn btn-primary">âš™ï¸ Configure Connector First</a>
        {% endif %}
    </div>
</div>

<div id="statusMessage" style="margin-top: 2rem; padding: 1rem; border-radius: 0.5rem; display: none;"></div>

<script>
function copyXML() {
    const xmlText = `{{ xml_data }}`;
    navigator.clipboard.writeText(xmlText).then(() => {
        showStatus('âœ… XML copied to clipboard!', 'success');
    }).catch(err => {
        showStatus('âŒ Failed to copy XML', 'error');
    });
}

function sendToConnector() {
    const btn = document.getElementById('sendBtn');
    btn.disabled = true;
    btn.textContent = 'â³ Sending...';
    
    fetch('/send-to-connector/{{ statement_id }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.textContent = 'ğŸ“¤ Send to Connector';
        
        if (data.success) {
            showStatus('âœ… ' + data.message + ' (at ' + data.timestamp + ')', 'success');
        } else {
            showStatus('âŒ Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.textContent = 'ğŸ“¤ Send to Connector';
        showStatus('âŒ Network error: ' + error, 'error');
    });
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.textContent = message;
    statusDiv.className = 'alert-' + type;
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}
</script>
{% endblock %}
